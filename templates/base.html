<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% if title %}
        <title>{{ title }} - Gerenciador de Eventos</title>
    {% else %}
        <title>Gerenciador de Eventos</title>
    {% endif %}
    {# Link para o Bootstrap CSS (versão 5.3.3) #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {# Link para o Font Awesome para ícones (versão 5.15.4 para compatibilidade com os exemplos) #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    {# NOVO: Link para o Select2 CSS #}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    {# NOVO: Link para o tema Bootstrap 5 do Select2 (opcional, mas recomendado para consistência visual) #}
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    {# NOVO: Import da fonte Roboto Condensed do Google Fonts #}
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    {# --- INÍCIO DA ADIÇÃO DO FLATPCIKR CSS --- #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    {# --- FIM DA ADIÇÃO DO FLATPCIKR CSS --- #}

    {# SEU CSS PERSONALIZADO (style.css) - AGORA COM CACHE-BUSTER E CARREGADO POR ÚLTIMO #}
    <link rel="stylesheet" href="{{ url_for('main.static', filename='css/style.css', v='20240928v06') }}"> {# Cache-buster atualizado #}
    {# PWA: Link para o Manifest da PWA #}
    <link rel="manifest" href="{{ url_for('main.static', filename='manifest.json') }}">
    {# PWA: Meta tags para compatibilidade com iOS #}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="{{ url_for('main.static', filename='images/icon-192x192.png') }}">
    {# NOVO: Link para o Favicon #}
    <link rel="icon" href="{{ url_for('main.static', filename='images/icon-192x192.png') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand fs-6 text-primary fw-bold" href="{{ url_for('main.home') }}" target="_top">
                <i class="fas fa-calendar-check me-2"></i> Gerenciador de Eventos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link fs-6 text-primary" href="{{ url_for('main.home') }}" target="_top">
                            <i class="fas fa-home me-1"></i> Home
                        </a>
                    </li>
                    {% if current_user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link fs-6 text-primary" href="{{ url_for('main.kanban_board') }}" target="_top">
                                <i class="fas fa-columns me-1"></i> Kanban {# AJUSTE: Link para o Kanban #}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fs-6 text-primary" href="{{ url_for('main.calendar_view') }}" target="_top">
                                <i class="fas fa-calendar-alt me-1"></i> Calendário
                            </a>
                        </li>
                        {% if current_user.is_admin %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle fs-6 text-primary" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-user-cog me-1"></i> Painel Admin
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                                    <li><a class="dropdown-item" href="/admin/" target="_top">Painel Flask-Admin</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.changelog') }}" target="_top">Histórico de Alterações</a></li>
                                </ul>
                            </li>
                        {% endif %}
                    {% endif %}
                </ul>
                <ul class="navbar-nav ms-auto">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item position-relative me-3">
                            <a class="nav-link fs-6 text-primary" href="{{ url_for('main.notifications') }}"  rel="noopener noreferrer" title="Notificações">
                                <i class="fas fa-bell"></i>
                                <span id="unread-notifications-badge"
                                      class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle"
                                      style="font-size: 0.65em; padding: 0.3em 0.5em;"
                                      {% if unread_notifications_count == 0 %}hidden{% endif %}>
                                    {{ unread_notifications_count }}
                                    <span class="visually-hidden">notificações não lidas</span>
                                </span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link text-primary fw-bold fs-6">
                                <i class="fas fa-user-circle me-1"></i> Olá, {{ current_user.username }}!
                            </span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn btn-outline-primary px-3 ms-lg-2 fs-6" href="{{ url_for('main.logout') }}" target="_top">
                                <i class="fas fa-sign-out-alt me-2"></i> Sair
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link fs-6 text-primary" href="{{ url_for('main.login') }}" target="_top">
                                <i class="fas fa-sign-in-alt me-1"></i> Login
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid mt-4">
        {# AJUSTE: Container para as mensagens Flash (do Flask e JS) #}
        <div class="flash-messages-container position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 1060;">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="row">
                        <div class="col-12">
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
        {# FIM DO AJUSTE PARA MENSAGENS FLASH #}

        <div class="content-wrapper">
            {% block content %}{% endblock %}
        </div>
    </div>
    <footer class="footer mt-5 py-3 bg-light border-top">
        <div class="container text-center">
            <span class="text-muted">
                &copy; {{ current_year }} Flexx Tecnologia e Softwares. Todos os direitos reservados.
            </span>
        </div>
    </footer>
    {# jQuery deve ser carregado antes de Bootstrap JS e Select2 #}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/pt-BR.js"></script>
    
    {# FullCalendar JS (global bundle) - USANDO UNPKG.COM COMO ALTERNATIVA #}
    <script src='https://unpkg.com/fullcalendar@6.1.11/index.global.min.js'></script>
    
    {# --- INÍCIO DA ADIÇÃO DO FLATPCIKR JS --- #}
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr Portuguese (Brazil) locale -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    {# --- FIM DA ADIÇÃO DO FLATPCIKR JS --- #}

    {# INCLUSÃO DO SORTABLE.JS AQUI #}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // AJUSTE: Inicialização global de tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    </script>
    {% block scripts %}
    {# O kanban.html terá seus scripts aqui, incluindo a Sortable.js e a lógica do Drag & Drop #}
    {# Seus scripts específicos de cada página serão renderizados aqui #}
    {% endblock %}

    {# NOVO: Script para registro do Service Worker e notificações PUSH #}
    <script>
        // Função utilitária para converter chave VAPID
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function subscribeUserToPush() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.warn('Service Worker ou Push API não suportados neste navegador.');
                // showFlashMessage('Seu navegador não suporta notificações push. Algumas funcionalidades podem estar limitadas.', 'warning');
                return;
            }

            try {
                const registration = await navigator.serviceWorker.ready;
                let subscription = await registration.pushManager.getSubscription();

                if (subscription) {
                    console.log('Usuário já inscrito para push notifications:', subscription);
                    // Opcional: reenviar subscription para o backend para garantir que esteja atualizada
                    await sendSubscriptionToServer(subscription);
                } else {
                    console.log('Obtendo chave VAPID pública...');
                    const response = await fetch('{{ url_for("main.get_vapid_public_key") }}');
                    if (!response.ok) {
                        throw new Error('Falha ao obter chave VAPID pública do servidor.');
                    }
                    const data = await response.json();
                    const vapidPublicKey = data.vapid_public_key;

                    if (!vapidPublicKey) {
                        throw new Error('Chave pública VAPID não configurada no servidor.');
                    }

                    const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);

                    console.log('Tentando subscrever para notificações push...');
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedVapidKey
                    });
                    console.log('Usuário inscrito com sucesso:', subscription);
                    await sendSubscriptionToServer(subscription);
                }
            } catch (error) {
                console.error('Falha ao subscrever usuário para push notifications:', error);
                // Disparar uma mensagem flash para o usuário
                const flashMessagesContainer = document.querySelector('.flash-messages-container');
                if (flashMessagesContainer) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                    alertDiv.setAttribute('role', 'alert');
                    alertDiv.innerHTML = `Não foi possível ativar as notificações: ${error.message || error}. Por favor, verifique as permissões do navegador e tente novamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
                    flashMessagesContainer.prepend(alertDiv);
                }
            }
        }

        async function sendSubscriptionToServer(subscription) {
            console.log('Enviando assinatura para o servidor...');
            try {
                const response = await fetch('{{ url_for("main.save_subscription") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}' // CORREÇÃO: Usar csrf_token como variável
                    },
                    body: JSON.stringify({ subscription: subscription.toJSON() })
                });
                const data = await response.json();
                if (data.success) {
                    console.log('Assinatura salva/atualizada no servidor.');
                } else {
                    console.error('Falha ao salvar/atualizar assinatura no servidor:', data.message);
                }
            } catch (error) {
                console.error('Erro de rede ao enviar assinatura ao servidor:', error);
            }
        }

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('{{ url_for("main.serve_service_worker") }}', { scope: '/' })
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        // Tentar subscrever para push notifications APÓS o SW estar registrado
                        subscribeUserToPush(); 
                    }, function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                        const flashMessagesContainer = document.querySelector('.flash-messages-container');
                        if (flashMessagesContainer) {
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                            alertDiv.setAttribute('role', 'alert');
                            alertDiv.innerHTML = `Não foi possível registrar o Service Worker (necessário para notificações). Erro: ${err.message || err}. Por favor, tente novamente mais tarde.
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
                            flashMessagesContainer.prepend(alertDiv);
                        }
                    });
            });
        } else {
            console.warn('Navegador não suporta Service Workers.');
        }
    </script>
</body>
</html>