{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4"> {# MODIFICADO: De 'container' para 'container-fluid' #}
    <h2 class="calendar-page-title">Calendário de Eventos e Tarefas</h2>

    {# Dropdown para seleção de visualização customizado para mobile E DESKTOP #}
    <div class="mb-3 w-100 w-lg-auto mx-lg-auto"> 
        <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="viewModeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Visualização: Mês {# Texto inicial do botão #}
        </button>
        <ul class="dropdown-menu" aria-labelledby="viewModeDropdown">
            <li><a class="dropdown-item" href="#" data-view="dayGridMonth">Mês</a></li>
            <li><a class="dropdown-item" href="#" data-view="timeGridWeek">Semana (Agenda)</a></li>
            <li><a class="dropdown-item" href="#" data-view="timeGridDay">Dia (Agenda)</a></li>
            <li><a class="dropdown-item" href="#" data-view="listWeek">Lista (Semana)</a></li>
            <li><hr class="dropdown-divider"></li> {# Separador #}
            <li><a class="dropdown-item" href="#" data-view="listMonth">Lista (Mês)</a></li>
            <li><a class="dropdown-item" href="#" data-view="listDay">Lista (Dia)</a></li>
        </ul>
    </div>

    <div id='calendar-container-wrapper' class="d-flex">
        <div id='calendar'></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        // As variáveis currentItemId e currentItemType foram removidas, pois não são mais necessárias.

        // Variável JS para o username do usuário logado (passado do Flask) - Mantido caso seja usado em outro lugar
const currentUsername = '{{ current_user.username if current_user.is_authenticated else "Usuário Desconhecido" }}';

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', 
            locale: 'pt-br',             
            customButtons: { 
                voltarHome: {
                    text: 'Voltar',
                    click: function() {
                        window.location.href = '{{ url_for('main.home') }}'; 
                    }
                }
            },
            headerToolbar: {
                left: 'prev,next voltarHome', 
                center: 'title',
                right: '' 
            },
            slotMinTime: '08:00:00', 
            slotMaxTime: '20:00:00', 
            height: 'auto',
            
            events: {
                url: '/api/calendar_events',
                method: 'GET',
                failure: function() {
                    alert('Houve um erro ao carregar os eventos!');
                }
            },
            // >>> AJUSTE AQUI: eventClick agora apenas redireciona diretamente <<<
            eventClick: function(info) {
                info.jsEvent.preventDefault(); // Impede qualquer comportamento padrão do FullCalendar
                if (info.event.url) {
                    window.location.href = info.event.url; // Redireciona para a URL do evento/tarefa
                }
            },
            // >>> AJUSTE AQUI: eventDidMount para garantir transparência total e estilo dos ícones <<<
            eventDidMount: function(info) {
                if (!info.view.type.startsWith('list')) {
                    // Seletores mais agressivos para garantir transparência
                    const $eventEl = $(info.el);
                    $eventEl.css({
                        'background-color': 'transparent',
                        'border-color': 'transparent',
                        'border-width': '0',
                        'color': 'transparent', // Garante que qualquer texto padrão seja invisível
                        'overflow': 'visible', // Permite que sombras e transições de hover não sejam cortadas
                        'height': 'auto', // Ajusta a altura da célula ao conteúdo
                        'min-height': 'auto' // Reseta o min-height padrão do FC
                    });

                    // Aplica transparência a todos os elementos internos do evento FullCalendar
                    $eventEl.find(
                        '.fc-event-start, .fc-event-end, .fc-event-time, .fc-event-title, ' +
                        '.fc-event-title-wrap, .fc-event-main, .fc-event-main-harness, ' +
                        '.fc-daygrid-event-dot'
                    ).css({
                        'background-color': 'transparent',
                        'border-color': 'transparent',
                        'border-width': '0',
                        'color': 'transparent', // Garante que qualquer texto padrão seja invisível
                        'height': 'auto',
                        'min-height': 'auto',
                        'line-height': '1' // Linha compacta
                    });
                    
                    // Ativar tooltip (se você quiser tooltips nos ícones)
                    $eventEl.tooltip({
                        title: info.event.extendedProps.description || info.event.title,
                        placement: 'top',
                        trigger: 'hover',
                        container: 'body'
                    });
                }
            },
            // >>> AJUSTE AQUI: eventContent para usar Font Awesome Free <<<
            eventContent: function(arg) {
                if (arg.view.type.startsWith('list')) {
                    // Para visualizações de lista, mantém o link clicável com o título completo
                    return { html: `<a class="fc-list-event-title-link" href="${arg.event.url}">${arg.event.title}</a>` };
                } else {
                    // Para dayGrid (Mês, Semana, Dia), exibe apenas o ícone.
                    let iconClasses = ''; 
                    let specificIconClass = ''; 
                    let iconTitle = arg.event.title || arg.event.extendedProps.description; 

                    if (arg.event.extendedProps.type === 'Tarefa') {
                        iconClasses = 'fas fa-clipboard-list'; // Ícone Font Awesome para Tarefa
                        specificIconClass = 'fc-event-task-icon'; 
                    } else if (arg.event.extendedProps.type === 'Evento') {
                        iconClasses = 'fas fa-calendar-alt'; // Ícone Font Awesome para Evento
                        specificIconClass = 'fc-event-event-icon'; 
                    }
                    
                    // Combina todas as classes para a tag <i>
                    return { html: `<div class="fc-event-display-wrapper"><i class="${iconClasses} ${specificIconClass}" aria-label="${iconTitle}"></i></div>` };
                }
            }
        });
        calendar.render();

        $('.dropdown-menu .dropdown-item').on('click', function(e) {
            e.preventDefault();
            var view = $(this).data('view');
            calendar.changeView(view);
            var viewText = $(this).text();
            $('#viewModeDropdown').text('Visualização: ' + viewText);
        });

        calendar.on('viewDidMount', function(viewInfo) {
            var currentViewText = '';
            if (viewInfo.view.type === 'dayGridMonth') currentViewText = 'Mês';
            else if (viewInfo.view.type === 'timeGridWeek') currentViewText = 'Semana (Agenda)';
            else if (viewInfo.view.type === 'timeGridDay') currentViewText = 'Dia (Agenda)';
            else if (viewInfo.view.type === 'listWeek') currentViewText = 'Lista (Semana)';
            else if (viewInfo.view.type === 'listMonth') currentViewText = 'Lista (Mês)';
            else if (viewInfo.view.type === 'listDay') currentViewText = 'Lista (Dia)';
            $('#viewModeDropdown').text('Visualização: ' + currentViewText);
        });

        // CÓDIGO REMOVIDO: Event listener para fechar a sidebar
        // CÓDIGO REMOVIDO: Funções de comentários (loadCommentsForItem, addCommentBtn)
    });
</script>
{% endblock %}